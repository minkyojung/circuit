# Terminal Integration - Compact Summary

## Context
Adding integrated terminal to TodoPanel with workspace-level isolation. Terminal shows in TodoPanel with transparent background and design tokens.

## Completed
- ✅ Terminal backend (terminalManager.ts) - PTY sessions per workspace
- ✅ Terminal frontend (TerminalContext.tsx, Terminal.tsx) - xterm.js integration
- ✅ Resizable TodoPanel (450px terminal height)
- ✅ Resize handle positioned at main area border (-ml-1)
- ✅ Fixed: duplicate handlers, font loading, type imports, useCallback stability

## Current Issues (NOT FIXED)
1. **Black Background** - Terminal still shows black instead of transparent
2. **Duplicate Prompts** - Each prompt renders twice ("williamjung@... %" appears 2x)

## Root Causes Found

### Black Background
- **Problem**: WebGL renderer doesn't support transparency (xterm.js Issue #4212)
- WebGL forces opaque background for accessibility
- CSS `!important` cannot override WebGL canvas
- **Solution**: Switch to Canvas renderer

### Duplicate Prompts  
- **Problem**: React Strict Mode + missing cleanup
- useEffect runs twice, creates 2 setTimeout timers
- Both timers fire after 300ms → 2 '\r' commands → 2 prompts
- **Solution**: Add proper cleanup function

## Critical Structural Issues

### 1. Broken useEffect Cleanup (MEMORY LEAK)
```typescript
// Terminal.tsx:152-157 - WRONG
const initTerminal = async () => {
  return () => resizeObserver.disconnect()  // Never runs!
}
initTerminal()  // Promise ignored, no cleanup
```
- ResizeObserver never cleaned up
- Multiple observers stack up
- Each resize triggers N IPC calls

### 2. Unstable Dependencies
```typescript
// Terminal.tsx:158
}, [workspace.id, workspace.path, getOrCreateTerminal])
//                ^^^^^^^^^^^^^^ 
```
- `workspace.path` reference changes trigger re-runs
- Even with same value, new object = new reference

### 3. Unsafe DOM Destruction
```typescript
// Terminal.tsx:27
terminalRef.current.innerHTML = ''  // Destroys xterm DOM
```
- Breaks xterm internal state
- `isAttached=true` but DOM gone
- State inconsistency

### 4. Map Anti-pattern
```typescript
// TerminalContext.tsx:96
const [terminals] = useState(new Map())
terminals.set(...)  // Direct mutation without setState
```
- Violates React immutability
- Should use useRef or useMemo

## Fix Plan

### Phase 1: Critical (Do Now)

**1. Switch WebGL → Canvas**
```typescript
// Terminal.tsx:68-86
const { CanvasAddon } = await import('@xterm/addon-canvas')
terminal.loadAddon(new CanvasAddon())  // Full transparency support
```

**2. Fix useEffect Cleanup**
```typescript
useEffect(() => {
  let mounted = true
  let timer: NodeJS.Timeout | null = null
  let observer: ResizeObserver | null = null
  
  const init = async () => {
    // ... existing code
    if (!hasInit && mounted) {
      timer = setTimeout(() => {
        if (mounted) ipcRenderer.invoke('terminal:write', wsId, '\r')
      }, 300)
    }
    observer = new ResizeObserver(...)
  }
  init()
  
  return () => {  // REAL cleanup
    mounted = false
    timer && clearTimeout(timer)
    observer?.disconnect()
  }
}, [workspace.id])  // Remove workspace.path
```

**3. Remove innerHTML**
```typescript
// Terminal.tsx:26-28 - DELETE THIS
// if (terminalRef.current) {
//   terminalRef.current.innerHTML = ''
// }

// Only attach when needed
if (!terminalData.isAttached && terminalRef.current) {
  terminal.open(terminalRef.current)
  terminalData.isAttached = true
}
```

### Phase 2: Architecture (Later)

**1. Map → useRef**
```typescript
const terminalsRef = useRef(new Map())
const getOrCreateTerminal = useCallback(async (...) => {
  const terminals = terminalsRef.current
}, [])  // No dependencies needed
```

**2. Buffer PTY data**
```typescript
// Buffer output until terminal attached
const pendingData = useRef(new Map())
```

## Files Modified in Session
- circuit/src/components/Terminal.tsx
- circuit/src/components/TodoPanel.tsx  
- circuit/src/contexts/TerminalContext.tsx
- circuit/src/App.tsx (resize handle)
- circuit/src/index.css (terminal styles)
- circuit/electron/terminalManager.ts

## Last Commit
`c1fdb45` - "fix: apply design tokens and fix terminal background transparency"

## Git Branch
`victoria` (tracking origin/victoria)

## Next Action
Apply Phase 1 fixes to resolve black background and duplicate prompts.
